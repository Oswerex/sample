<!DOCTYPE html>
<html lang="fil">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Safety Training with Assessment</title>

<style>
:root {
    --primary:#0b5fff;
    --danger:#cc0033;
    --success:#1a7f37;
    --muted:#666;
    --card-bg:#ffffffcc;
    --bg:#e9efff;
}
body {
    background: linear-gradient(135deg,#0b5fff33,#ffffff);
    font-family: Arial, sans-serif;
    margin:0;
    padding:20px;
    line-height:1.5;
}
.container { max-width:900px; margin:auto; }
.card {
    background: var(--card-bg);
    backdrop-filter: blur(6px);
    border-radius:10px;
    padding:20px;
    box-shadow:0 3px 12px rgba(0,0,0,0.12);
    margin-top:20px;
}
.hidden { display:none; }
.btn { padding:10px 16px; border:none; border-radius:6px; cursor:pointer; font-weight:600; }
.btn-primary { background: var(--primary); color:#fff; }
.btn-muted { background:#e5e5e5; color:#333; }

input[type="text"] {
    padding:8px;
    border:1px solid #ccc;
    border-radius:6px;
    width:250px;
}

.orientation-container {
    text-align:center;
}
.orientation-img {
    max-width:100%;
    border-radius:10px;
    margin-bottom:10px;
}
.orientation-controls {
    display:flex;
    justify-content:center;
    gap:10px;
}

.question { font-weight:600; margin-bottom:6px; }
.question-block { margin-bottom:18px; }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<div class="container">

<h2>Safety Orientation</h2>

<!-- IMAGE ORIENTATION -->
<div class="card orientation-card">
    <h3>Note: Please view all slides until the end to start the assessment</h3>
    <div class="orientation-container">
        <img id="slideImg" class="orientation-img" src="assets/slide1.jpg" alt="Orientation Slide">
    </div>
    <div class="orientation-controls">
        <button id="prevSlideBtn" class="btn btn-muted" disabled>Previous</button>
        <button id="nextSlideBtn" class="btn btn-primary">Next</button>
    </div>
</div>

<div class="card">
    <label>
        <input type="checkbox" id="watchedChk" disabled> I confirm that I have viewed all slides.
    </label>
    <br><br>
    <button id="startBtn" class="btn btn-primary" disabled>Start Assessment</button>
    <button id="resetBtn" class="btn btn-muted hidden">Reset</button>
</div>

<!-- ASSESSMENT -->
<div id="assessment" class="card hidden">
    <h3>Assessment</h3>
    <div id="questionContainer"></div>
    <div class="question-block">
        <label class="question">Name:</label><br>
        <input type="text" id="traineeName" placeholder="Juan Dela Cruz">
    </div>
    <button id="submitBtn" class="btn btn-primary">Submit</button>
    <button id="retakeBtn" class="btn btn-muted hidden">Retake Assessment</button>
</div>

<div id="result" class="card hidden"></div>

</div>

<script>
// --- IMAGE ORIENTATION LOGIC ---
const slides = [];
for(let i=1;i<=26;i++) slides.push(`assets/slide${i}.jpg`);

let currentSlide = 0;

const slideImg = document.getElementById('slideImg');
const prevSlideBtn = document.getElementById('prevSlideBtn');
const nextSlideBtn = document.getElementById('nextSlideBtn');
const watchedChk = document.getElementById('watchedChk');
const startBtn = document.getElementById('startBtn');
const assessment = document.getElementById('assessment');
const resetBtn = document.getElementById('resetBtn');
const submitBtn = document.getElementById('submitBtn');
const retakeBtn = document.getElementById('retakeBtn');
const resultDiv = document.getElementById('result');
const questionContainer = document.getElementById('questionContainer');

let attemptCount = 1;

function updateSlide() {
    slideImg.src = slides[currentSlide];
    prevSlideBtn.disabled = currentSlide === 0;
    nextSlideBtn.disabled = currentSlide === slides.length - 1;
    watchedChk.disabled = currentSlide !== slides.length - 1;
    if (!watchedChk.disabled) watchedChk.checked = false;
}

prevSlideBtn.addEventListener('click', () => { if(currentSlide>0) currentSlide--; updateSlide(); });
nextSlideBtn.addEventListener('click', () => { if(currentSlide<slides.length-1) currentSlide++; updateSlide(); });

watchedChk.addEventListener('change', () => { startBtn.disabled = !watchedChk.checked; });

startBtn.addEventListener('click', () => {
    assessment.classList.remove('hidden');
    resetBtn.classList.remove('hidden');
    resultDiv.classList.add('hidden');
    renderQuestions(); // render random questions per session
});

resetBtn.addEventListener('click', resetAll);
retakeBtn.addEventListener('click', () => { attemptCount++; resetAll(); renderQuestions(); });

function resetAll(){
    questionContainer.innerHTML="";
    document.getElementById('traineeName').value="";
    resultDiv.innerHTML="";
    resultDiv.classList.add('hidden');
}

// --- QUESTIONS DATA ---
const questions = [
    {q:"Gaano katagal ang bisa ng Work Permit para sa High-Risk na trabaho?", options:["1 araw","1 linggo","1 buwan","6 na buwan"], correct:"1 buwan"},
    {q:"Anong dokumento ang kailangan kasama ng Work Permit para sa High-Risk na trabaho?", options:["Job Hazard Analysis","MSDS","Work Permit lamang","Safety Checklist"], correct:"JHA"},
    {q:"Sino ang dapat naroon bago magsimula ang High-Risk na aktibidad?", options:["Worker lamang","Safety Officer o Supervisor","Engineer","Manager"], correct:"Safety Officer o Supervisor"},
    {q:"Ano ang maximum speed limit sa loob ng Meralco Operating Center?", options:["20 KPH","30 KPH","40 KPH","50 KPH"], correct:"30 KPH"},
    {q:"Ano ang unang bawal ayon sa Fire Safety Rules ng Meralco?", options:["Paninigarilyo","Open Flames","Running","Eating"], correct:"Paninigarilyo"},
    {q:"Ano ang unang dapat gawin kapag may lindol?", options:["Run","Duck – Cover – Hold","Hide","Call"], correct:"Duck – Cover – Hold"},
    {q:"Kung ikaw ay Heavy Equipment Operator, anong dokumento ang dapat meron ka?", options:["License","Heavy Equipment NC II Certification","Work Permit lamang","Safety Checklist"], correct:"Heavy Equipment NC II Certification"},
    {q:"Saan ang Emergency Assembly Point sa Area 2?", options:["Sa harap ng parking ng Technical Service Building","Sa likod ng Operation Building","Sa harap ng gate 2","Sa labas ng MERALCO"], correct:"Sa harap ng parking ng Technical Service Building"},
    {q:"Anong dokumento ang dapat palaging dala kapag may aktibidad sa loob ng Meralco?", options:["Approved Work Permit","ID","Safety Checklist","License"], correct:"Approved Work Permit"},
    {q:"Anong materyales ang bawal dalhin sa loob ng Meralco Operating Center?", options:["Single-Use Plastics","Food","Bags","Electronics"], correct:"Single-Use Plastics"}
];

// --- SHUFFLE FUNCTION ---
function shuffleArray(array) {
    let arr = array.slice();
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}

// --- RENDER QUESTIONS RANDOMLY ---
function renderQuestions() {
    questionContainer.innerHTML="";
    const shuffledQuestions = shuffleArray(questions);
    shuffledQuestions.forEach((qObj, index) => {
        const block = document.createElement('div');
        block.className="question-block";
        block.innerHTML = `<label class="question">${index+1}. ${qObj.q}</label><br>` +
            qObj.options.map(opt=>`<label><input type="radio" name="q${index+1}" value="${opt}"> ${opt}</label><br>`).join('');
        block.dataset.correct=qObj.correct;
        questionContainer.appendChild(block);
    });
}

// --- SUBMIT LOGIC WITH RANDOMIZED QUESTIONS ---
submitBtn.addEventListener('click', async () => {
    let score=0;
    const blocks = questionContainer.querySelectorAll(".question-block");
    blocks.forEach((block, i) => {
        const selected = block.querySelector('input[type="radio"]:checked');
        if(selected && selected.value === block.dataset.correct) score++;
    });

    let name = document.getElementById('traineeName').value.trim();
    if(!name) return alert("Pakilagay ang pangalan.");

    let result = (score===10) ? "PASS" : "FAIL";

    const APP_SCRIPT_URL="https://script.google.com/macros/s/AKfycbyBql2dvKoJ0IuzXEXOAhsgABQy1_il_bFJrXPMB1EbMvqyOVvhLckFZaMRZAsx6TpZ/exec";
    const SECRET="V9x!7Qm#4sP@2kT8zL$1gR";

    try{
        await fetch(APP_SCRIPT_URL,{
            method:"POST",
            mode:"no-cors",
            headers:{ "Content-Type":"application/json" },
            body:JSON.stringify({ token:SECRET, name:name, score:score, result:result, attempts:attemptCount })
        });
    }catch(e){}

    resultDiv.classList.remove('hidden');
    if(result==="PASS"){
        resultDiv.innerHTML="<h3 class='result-pass'>PASADO!</h3><p>Generating certificate…</p>";
        generateCertificate(name);
        retakeBtn.classList.add('hidden');
    } else {
        resultDiv.innerHTML="<h3 class='result-fail'>You FAILED.</h3><p>Try again.</p>";
        retakeBtn.classList.remove('hidden');
    }
});

// --- CERTIFICATE FUNCTION ---
async function generateCertificate(name){
    const {jsPDF}=window.jspdf;
    const doc=new jsPDF({unit:"pt",format:"a4"});

    doc.setFillColor(255,140,0);
    doc.rect(0,0,595,80,'F');

    const img = new Image();
    img.src="https://raw.githubusercontent.com/Oswerex/ESH/6acfa4af336cce3696a01fea102eeaa626a67e01/ESHM%20Logo.png";
    img.onload=function(){
        doc.addImage(img,'PNG',241,10,108,72);
        doc.setFontSize(28);
        doc.setTextColor(0,0,0);
        doc.text("Certificate of Completion",300,120,{align:"center"});
        doc.setFontSize(16);
        doc.text("This certifies that:", 300, 210, { align: "center" });
        doc.setFontSize(24);
        doc.text(name.toUpperCase(), 300, 245, { align: "center" });
        doc.setFontSize(14);
        doc.text("Successfully completed the Safety Orientation Assessment",300,285,{align:"center"});
        doc.save(`Certificate_${name}.pdf`);
    }
}

// initialize first slide
updateSlide();
</script>

</body>
</html>

