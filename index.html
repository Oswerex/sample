<!DOCTYPE html>
<html lang="fil">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Safety Training with Assessment</title>

<style>
:root {
    --primary:#0b5fff;
    --danger:#cc0033;
    --success:#1a7f37;
    --muted:#666;
    --card-bg:#ffffffcc;
    --bg:#e9efff;
}
body {
    background: linear-gradient(135deg,#0b5fff33,#ffffff);
    font-family: Arial, sans-serif;
    margin:0;
    padding:20px;
    line-height:1.5;
}
.container { max-width:900px; margin:auto; }
.card {
    background: var(--card-bg);
    backdrop-filter: blur(6px);
    border-radius:10px;
    padding:20px;
    box-shadow:0 3px 12px rgba(0,0,0,0.12);
    margin-top:20px;
}
.hidden { display:none; }
.btn { padding:10px 16px; border:none; border-radius:6px; cursor:pointer; font-weight:600; }
.btn-primary { background: var(--primary); color:#fff; }
.btn-muted { background:#e5e5e5; color:#333; }

input[type="text"] {
    padding:8px;
    border:1px solid #ccc;
    border-radius:6px;
    width:250px;
}

.orientation-container { text-align:center; }
.orientation-img {
    max-width:100%;
    border-radius:10px;
    margin-bottom:10px;
}
.orientation-controls {
    display:flex;
    justify-content:center;
    gap:10px;
}

.question { font-weight:600; margin-bottom:6px; }
.question-block { margin-bottom:18px; }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<div class="container">

<h2>Safety Orientation</h2>

<!-- IMAGE ORIENTATION -->
<div class="card orientation-card">
    <h3>Note: Please view all slides until the end to start the assessment</h3>
    <div class="orientation-container">
        <img id="slideImg" class="orientation-img" src="assets/slide1.jpg">
    </div>
    <div class="orientation-controls">
        <button id="prevSlideBtn" class="btn btn-muted" disabled>Previous</button>
        <button id="nextSlideBtn" class="btn btn-primary">Next</button>
    </div>
</div>

<div class="card">
    <label>
        <input type="checkbox" id="watchedChk" disabled> I confirm that I have viewed all slides.
    </label>
    <br><br>
    <button id="startBtn" class="btn btn-primary" disabled>Start Assessment</button>
    <button id="resetBtn" class="btn btn-muted hidden">Reset</button>
</div>

<!-- ASSESSMENT -->
<div id="assessment" class="card hidden">
    <h3>Assessment</h3>
    <div id="questionContainer"></div>

    <div class="question-block">
        <label class="question">Company Name:</label><br>
        <input type="text" id="companyName" placeholder="ABC Construction Corp.">
    </div>

    <div class="question-block">
        <label class="question">Name:</label><br>
        <input type="text" id="traineeName" placeholder="Juan Dela Cruz">
    </div>

    <button id="submitBtn" class="btn btn-primary">Submit</button>
    <button id="retakeBtn" class="btn btn-muted hidden">Retake Assessment</button>
</div>

<div id="result" class="card hidden"></div>

</div>

<script>
// --- IMAGE ORIENTATION LOGIC ---
const slides = [];
for(let i=1;i<=26;i++) slides.push(`assets/slide${i}.jpg`);

let currentSlide = 0;
let attemptCount = 1;

const slideImg = document.getElementById('slideImg');
const prevSlideBtn = document.getElementById('prevSlideBtn');
const nextSlideBtn = document.getElementById('nextSlideBtn');
const watchedChk = document.getElementById('watchedChk');
const startBtn = document.getElementById('startBtn');
const assessment = document.getElementById('assessment');
const resetBtn = document.getElementById('resetBtn');
const submitBtn = document.getElementById('submitBtn');
const retakeBtn = document.getElementById('retakeBtn');
const resultDiv = document.getElementById('result');
const questionContainer = document.getElementById('questionContainer');

function updateSlide() {
    slideImg.src = slides[currentSlide];
    prevSlideBtn.disabled = currentSlide === 0;
    nextSlideBtn.disabled = currentSlide === slides.length - 1;
    watchedChk.disabled = currentSlide !== slides.length - 1;
    if (!watchedChk.disabled) watchedChk.checked = false;
}

prevSlideBtn.onclick=()=>{ if(currentSlide>0) currentSlide--; updateSlide(); }
nextSlideBtn.onclick=()=>{ if(currentSlide<slides.length-1) currentSlide++; updateSlide(); }
watchedChk.onchange=()=> startBtn.disabled=!watchedChk.checked;

startBtn.onclick=()=>{
    assessment.classList.remove('hidden');
    resetBtn.classList.remove('hidden');
    resultDiv.classList.add('hidden');
    renderQuestions();
}

resetBtn.onclick=()=>resetAll();
retakeBtn.onclick=()=>{ attemptCount++; resetAll(); renderQuestions(); }

function resetAll(){
    questionContainer.innerHTML="";
    document.getElementById('traineeName').value="";
    document.getElementById('companyName').value="";
    resultDiv.classList.add('hidden');
}

// QUESTIONS
const questions=[
 {q:"Gaano katagal ang bisa ng Work Permit para sa High-Risk na trabaho?",opts:["1 araw","1 linggo","1 buwan","6 na buwan"],a:"1 buwan"},
 {q:"You are assigned to perform hot work but do not have a work permit. What should you do?",opts:["Start work since you have done it before","Ask a colleague if their permit can be used","Proceed only after obtaining an approved work permit","Perform the task quickly to avoid delays"],a:"Proceed only after obtaining an approved work permit"},
 {q:"You hear an emergency alarm while working. What should you do?",opts:[" Finish your task quickly before leaving","Panic and run to the nearest exit","Stop work and proceed calmly to the designated assembly area"," Wait for instructions from co-workers"],a:"Stop work and proceed calmly to the designated assembly area"},
 {q:"Ano ang maximum speed limit?",opts:["20 KPH","30 KPH","40 KPH","50 KPH"],a:"30 KPH"},
 {q:"There's smoking areas inside the Meralco Compound",opts:["True","False"],a:"False"},
 {q:"You experienced a minor injury that did not require medical treatment. What should you do?",opts:[" Ignore it since it is minor","Report the incident to your supervisor or safety officer","Treat it yourself and continue working","Only report if it becomes serious"],a:"Report the incident to your supervisor or safety officer"},
 {q:"Anong Dokumento ang dapat na meron ka kung mag operate ka ng Heavy Equipment?",opts:["License","NC II Certification","Permit","Checklist"],a:"NC II Certification"},
 {q:"The Job Hazard analysis is required for High-risked activities",opts:["True","False"],a:"True"},
 {q:"Dokumentong dapat dala kapag meron kang aktibidad sa loob ng kahit anong MERALCO Establishment?",opts:["Approved Work Permit","ID","Checklist","License"],a:"Approved Work Permit"},
 {q:"Plastic bags are permitted inside any Meralco facility",opts:["True","False"],a:"False"}
];

// SHUFFLE
function shuffleArray(arr){
    let a=arr.slice();
    for(let i=a.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
}

// RENDER QUESTIONS
function renderQuestions(){
    questionContainer.innerHTML="";
    const shuffled = shuffleArray(questions);
    shuffled.forEach((q,i)=>{
        const d=document.createElement("div");
        d.className="question-block";
        d.dataset.correct=q.a;
        d.innerHTML=`<label class="question">${i+1}. ${q.q}</label><br>`+
            shuffleArray(q.opts).map(o=>`<label><input type="radio" name="q${i}" value="${o}"> ${o}</label><br>`).join("");
        questionContainer.appendChild(d);
    });
}

// BACK TO START FUNCTION
function backToStart(messageHTML){
    setTimeout(()=>{
        // balik sa orientation
        assessment.classList.add("hidden");
        resultDiv.classList.add("hidden");

        // reset slides
        currentSlide = 0;
        updateSlide();
        watchedChk.checked = false;
        watchedChk.disabled = true;
        startBtn.disabled = true;

        // clear inputs
        document.getElementById('traineeName').value = "";
        document.getElementById('companyName').value = "";

        // reset questions
        questionContainer.innerHTML = "";

        // optional message sa taas
        if(messageHTML){
            const notice = document.createElement("div");
            notice.className = "card";
            notice.innerHTML = messageHTML;
            document.querySelector(".container").prepend(notice);

            setTimeout(()=>notice.remove(),5000);
        }
    }, 2500); // konting delay para mabasa result
}

// SUBMIT
submitBtn.onclick=async()=>{
    let score=0;
    document.querySelectorAll(".question-block").forEach(b=>{
        const s=b.querySelector("input:checked");
        if(s && s.value === b.dataset.correct) score++;
    });

    const name=document.getElementById("traineeName").value.trim();
    const company=document.getElementById("companyName").value.trim();
    if(!name||!company) return alert("Please complete Name and Company.");

    const result=score===10?"PASS":"FAIL";

    const APP_SCRIPT_URL="https://script.google.com/macros/s/AKfycbzn_Iqm9qs5jbi07FqRAFEnzpxoDyEndCfghptRDJdkxo_KYea6bqQBMZeOOUVW8vYc/exec";
    const SECRET="V9x!7Qm#4sP@2kT8zL$1gR";

    await fetch(APP_SCRIPT_URL,{
        method:"POST",
        mode:"no-cors",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
            token:SECRET,
            name:name,
            company:company,
            score:score,
            result:result,
            attempts:attemptCount
        })
    });

    resultDiv.classList.remove("hidden");

    if(result==="PASS"){
        resultDiv.innerHTML = `
            <h3>PASADO!</h3>
            <p>Score: ${score}/10</p>
            <p>Generating certificateâ€¦</p>
        `;
        generateCertificate(name,company);

        backToStart(`
            <h3 style="color:green">Assessment Completed</h3>
            <p>You may start a new assessment.</p>
        `);

    }else{
        resultDiv.innerHTML = `
            <h3>FAILED</h3>
            <p>Score: ${score}/10</p>
            <p><strong>For Re-assessment</strong></p>
        `;

        backToStart(`
            <h3 style="color:#cc0033">For Re-assessment</h3>
            <p>Previous Score: ${score}/10</p>
        `);
    }
}

// CERTIFICATE
function generateCertificate(name,company){
    const {jsPDF}=window.jspdf;
    const doc=new jsPDF({unit:"pt",format:"a4"});

    doc.setFillColor(255,140,0);
    doc.rect(0,0,595,80,'F');
    
    const today=new Date();
    const validUntil=new Date(today);
    validUntil.setMonth(today.getMonth()+6);

    doc.setFontSize(28);
    doc.text("Certificate of Completion",300,120,{align:"center"});
    doc.setFontSize(16);
    doc.text("This certifies that:",300,200,{align:"center"});
    doc.setFontSize(24);
    doc.text(name.toUpperCase(),300,235,{align:"center"});
    doc.setFontSize(14);
    doc.text(`Company: ${company}`,300,265,{align:"center"});
    doc.text("Successfully completed the Safety Orientation Assessment",300,295,{align:"center"});
    doc.text(`Valid Until: ${validUntil.toDateString()}`,300,330,{align:"center"});

    doc.save(`Certificate_${name}.pdf`);
}

updateSlide();
</script>
</body>
</html>
